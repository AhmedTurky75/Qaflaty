@if (isChatEnabled()) {
  <!-- Chat Widget Container -->
  <div class="chat-widget-container" [class.rtl]="i18n.isRtl()">
    <!-- Floating Chat Button -->
    @if (!isExpanded() && !isMinimized()) {
      <button
        class="chat-toggle-btn"
        (click)="toggleChat()"
        [attr.aria-label]="i18n.isRtl() ? 'فتح الدردشة' : 'Open chat'"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>

        <!-- Unread Badge -->
        @if (chatService.unreadCount() > 0) {
          <span class="unread-badge">{{ chatService.unreadCount() }}</span>
        }
      </button>
    }

    <!-- Minimized Chat Bar -->
    @if (isMinimized()) {
      <div class="chat-minimized-bar" (click)="toggleChat()">
        <div class="minimized-content">
          <svg xmlns="http://www.w3.org/2000/svg" class="minimized-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span class="minimized-text">
            {{ i18n.isRtl() ? 'الدردشة المباشرة' : 'Live Chat' }}
          </span>

          @if (chatService.unreadCount() > 0) {
            <span class="unread-badge">{{ chatService.unreadCount() }}</span>
          }
        </div>
      </div>
    }

    <!-- Expanded Chat Window -->
    @if (isExpanded()) {
      <div class="chat-window">
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="header-content">
            <div class="header-title">
              <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <div>
                <h3 class="header-text">{{ i18n.isRtl() ? 'الدردشة المباشرة' : 'Live Chat' }}</h3>
                @if (chatService.isConnected()) {
                  <p class="header-status online">
                    <span class="status-dot"></span>
                    {{ i18n.isRtl() ? 'متصل' : 'Online' }}
                  </p>
                } @else {
                  <p class="header-status offline">
                    <span class="status-dot"></span>
                    {{ i18n.isRtl() ? 'غير متصل' : 'Offline' }}
                  </p>
                }
              </div>
            </div>

            <div class="header-actions">
              <button
                class="header-btn"
                (click)="minimizeChat()"
                [attr.aria-label]="i18n.isRtl() ? 'تصغير' : 'Minimize'"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <button
                class="header-btn"
                (click)="toggleChat()"
                [attr.aria-label]="i18n.isRtl() ? 'إغلاق' : 'Close'"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chat-messages-container">
          @if (isLoadingConversation()) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>{{ i18n.isRtl() ? 'جاري التحميل...' : 'Loading...' }}</p>
            </div>
          } @else if (chatService.error()) {
            <div class="error-state">
              <p>{{ chatService.error() }}</p>
            </div>
          } @else if (chatService.messages().length === 0) {
            <!-- Welcome Message -->
            <div class="welcome-message">
              <svg xmlns="http://www.w3.org/2000/svg" class="welcome-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <h4>{{ i18n.isRtl() ? 'مرحباً بك!' : 'Welcome!' }}</h4>
              <p>
                {{ i18n.isRtl()
                  ? 'كيف يمكننا مساعدتك اليوم؟'
                  : 'How can we help you today?'
                }}
              </p>
            </div>
          } @else {
            <!-- Messages List -->
            @for (message of chatService.messages(); track message.id) {
              <div
                class="message"
                [class.message-customer]="isCustomerMessage(message)"
                [class.message-merchant]="!isCustomerMessage(message)"
              >
                <div class="message-bubble">
                  <div class="message-sender">{{ getSenderName(message) }}</div>
                  <div class="message-content">{{ message.content }}</div>
                  <div class="message-time">
                    {{ formatTime(message.sentAt) }}
                    @if (isCustomerMessage(message)) {
                      @if (message.readAt) {
                        <svg xmlns="http://www.w3.org/2000/svg" class="read-receipt" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="20 6 9 17 4 12"></polyline>
                          <polyline points="20 6 9 17 4 12" transform="translate(3, 0)"></polyline>
                        </svg>
                      } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" class="sent-receipt" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      }
                    }
                  </div>
                </div>
              </div>
            }

            <!-- Typing Indicator -->
            @if (chatService.isMerchantTyping()) {
              <div class="message message-merchant">
                <div class="message-bubble typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            }
          }
        </div>

        <!-- Chat Input -->
        <div class="chat-input-container">
          <form (submit)="sendMessage(); $event.preventDefault()" class="chat-form">
            <input
              type="text"
              class="chat-input"
              [placeholder]="i18n.isRtl() ? 'اكتب رسالتك...' : 'Type your message...'"
              [(ngModel)]="messageInput"
              (ngModelChange)="onInputChange()"
              [disabled]="isSendingMessage()"
              name="message"
            />
            <button
              type="submit"
              class="send-btn"
              [disabled]="!messageInput().trim() || isSendingMessage()"
              [attr.aria-label]="i18n.isRtl() ? 'إرسال' : 'Send'"
            >
              @if (isSendingMessage()) {
                <div class="btn-spinner"></div>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              }
            </button>
          </form>
        </div>
      </div>
    }
  </div>
}
